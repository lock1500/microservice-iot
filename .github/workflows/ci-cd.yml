name: Build and Deploy to Minikube

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  build-push-deploy:
    runs-on: self-hosted

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Log in to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Build & Push IMLine image
      uses: docker/build-push-action@v6
      with:
        context: ./IMLine
        file: ./IMLine/Dockerfile
        push: true
        tags: ${{ secrets.DOCKERHUB_USERNAME }}/im-line:latest

    - name: Build & Push IMTelegram image
      uses: docker/build-push-action@v6
      with:
        context: ./IMTelegram
        file: ./IMTelegram/Dockerfile
        push: true
        tags: ${{ secrets.DOCKERHUB_USERNAME }}/im-telegram:latest

    - name: Build & Push IoTESP32 image
      uses: docker/build-push-action@v6
      with:
        context: ./IoTESP32
        file: ./IoTESP32/Dockerfile
        push: true
        tags: ${{ secrets.DOCKERHUB_USERNAME }}/iot-esp32:latest

    - name: Build & Push IoTRaspberryPi image
      uses: docker/build-push-action@v6
      with:
        context: ./IoTRaspberrypi
        file: ./IoTRaspberrypi/Dockerfile
        push: true
        tags: ${{ secrets.DOCKERHUB_USERNAME }}/iot-raspberrypi:latest
     
    - name: Install RabbitMQ Cluster Operator
      run: |
        helm repo add bitnami https://charts.bitnami.com/bitnami
        helm repo update
        helm upgrade --install rabbit-operator bitnami/rabbitmq-cluster-operator -n messaging --create-namespace    

    - name: Install Kong Ingress Controller
      run: |
        helm repo add kong https://charts.konghq.com
        helm repo update
        helm install kong kong/ingress -n kong --create-namespace --set ingressController.installCRDs=true --set proxy.type=NodePort   

    - name: Deploy to Kubernetes
      run: |
        kubectl apply -f ./rabbitMQ/rabbitmq_cluster.yml
        kubectl applt -f ./ingress.yml

        kubectl apply -f ./IMLine/k8s/Linebot-Secret.yml
        kubectl apply -f ./IMLine/k8s/Deployment.yml
        kubectl apply -f ./IMLine/k8s/Service.yml

        kubectl apply -f ./IMTelegram/k8s/deployment.yaml

        kubectl apply -f ./IoTESP32/k8s/device-confmap.yml
        kubectl apply -f ./IoTESP32/k8s/ecdsa-key-secret.yml
        kubectl apply -f ./IoTESP32/k8s/Deployment.yml
        kubectl apply -f ./IoTESP32/k8s/Service.yml

        kubectl apply -f ./IoTRaspberrypi/k8s/device-confmap.yml
        kubectl apply -f ./IoTRaspberrypi/k8s/ecdsa-key-secret.yml
        kubectl apply -f ./IoTRaspberrypi/k8s/Deployment.yml
        kubectl apply -f ./IoTRaspberrypi/k8s/Service.yml

        kubectl apply -f ./Mosquitto/mosquitto-config.yml
        kubectl apply -f ./Mosquitto/mosquitto-deployment.yml
        kubectl apply -f ./Mosquitto/mosquitto-service.yml


    - name: Update image tag
      run: |
        kubectl set image deployment/im-line im-line=${{ secrets.DOCKERHUB_USERNAME }}/im-line:latest
        kubectl set image deployment/im-telegram im-telegram=${{ secrets.DOCKERHUB_USERNAME }}/im-telegram:latest
        kubectl set image deployment/iot-esp32 iot-esp32=${{ secrets.DOCKERHUB_USERNAME }}/iot-esp32:latest
        kubectl set image deployment/iot-raspberrypi iot-raspberrypi=${{ secrets.DOCKERHUB_USERNAME }}/iot-raspberrypi:latest